<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>现代前端架构设计与性能优化 | Bruce的博客</title>
<meta name=keywords content="架构设计,性能优化,React,前端工程化"><meta name=description content="从分形到原子的性能提升之旅：如何将一个大型React应用的首屏加载时间从8.6秒降至1.2秒"><meta name=author content><link rel=canonical href=https://www.yss520.online/zh/posts/architecture-and-performance/><link crossorigin=anonymous href=/assets/css/stylesheet.50fb993581dec76187b65aabd179be9f0f5b64458c619ef95b7016d351ad64db.css integrity="sha256-UPuZNYHex2GHtlqr0Xm+nw9bZEWMYZ75W3AW01GtZNs=" rel="preload stylesheet" as=style><link rel=icon href=https://www.yss520.online/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.yss520.online/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.yss520.online/favicon-32x32.png><link rel=apple-touch-icon href=https://www.yss520.online/apple-touch-icon.png><link rel=mask-icon href=https://www.yss520.online/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.yss520.online/zh/posts/architecture-and-performance/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:type" content="article"><meta property="og:url" content="https://www.yss520.online/zh/posts/architecture-and-performance/"><meta property="og:title" content="现代前端架构设计与性能优化 | Bruce的博客"><meta property="og:description" content="从分形到原子的性能提升之旅：如何将一个大型React应用的首屏加载时间从8.6秒降至1.2秒"><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://www.yss520.online/zh/posts/architecture-and-performance/"><meta property="twitter:title" content="现代前端架构设计与性能优化 | Bruce的博客"><meta property="twitter:description" content="从分形到原子的性能提升之旅：如何将一个大型React应用的首屏加载时间从8.6秒降至1.2秒"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.yss520.online\/zh\/posts\/architecture-and-performance\/"},"headline":"现代前端架构设计与性能优化","description":"从分形到原子的性能提升之旅：如何将一个大型React应用的首屏加载时间从8.6秒降至1.2秒","image":[],"datePublished":"2023-07-25T22:13:24\u002b08:00","dateModified":"2023-07-25T22:13:24\u002b08:00","author":{"@type":"Person","name":""},"publisher":{"@type":"Organization","name":"Bruce的博客","logo":{"@type":"ImageObject","inLanguage":"zh","url":"https:\/\/www.yss520.online\/images\/logo.svg"}}}</script><style>img[src^="/"]{content:attr(src)}.not-found-container{min-height:70vh}.lightbox{z-index:9999}.lb-outerContainer{border-radius:8px}.lb-dataContainer{border-radius:0 0 8px 8px}.lb-image{border-radius:4px}</style><script>document.addEventListener("DOMContentLoaded",function(){const t=document.documentElement.lang||"en",e=window.location.origin;function s(){const e=document.querySelectorAll("img");e.forEach(e=>{e.getAttribute("src")&&(e.onerror=function(){o(this)})})}function o(s){if(!s.src)return;const i=s.src,o=i.startsWith(e)?i.substring(e.length):i;if(s.dataset.triedPaths){const e=JSON.parse(s.dataset.triedPaths);if(e.includes(o))return;e.push(o),s.dataset.triedPaths=JSON.stringify(e)}else s.dataset.triedPaths=JSON.stringify([o]);const a=[`/images${o}`,`/images/${o.replace(/^\//,"")}`,`/images/${t}${o}`,o.replace(`/${t}/`,"/"),o.replace(/^\/[a-z]{2}\//,"/"),`/static${o}`,`/static/images${o}`];n(s,a,0)}function n(t,s,o){if(o>=s.length){t.src="/images/placeholder.svg",t.onerror=null;return}const i=s[o],a=i.startsWith("http")?i:`${e}${i}`;t.onerror=function(){n(t,s,o+1)},t.src=a}s()})</script><meta property="og:url" content="https://www.yss520.online/zh/posts/architecture-and-performance/"><meta property="og:site_name" content="Bruce的博客"><meta property="og:title" content="现代前端架构设计与性能优化"><meta property="og:description" content="从分形到原子的性能提升之旅：如何将一个大型React应用的首屏加载时间从8.6秒降至1.2秒"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-25T22:13:24+08:00"><meta property="article:modified_time" content="2023-07-25T22:13:24+08:00"><meta property="article:tag" content="架构设计"><meta property="article:tag" content="性能优化"><meta property="article:tag" content="React"><meta property="article:tag" content="前端工程化"><meta property="og:image" content="https://www.yss520.online/images/real-covers/architecture.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.yss520.online/images/real-covers/architecture.jpg"><meta name=twitter:title content="现代前端架构设计与性能优化"><meta name=twitter:description content="从分形到原子的性能提升之旅：如何将一个大型React应用的首屏加载时间从8.6秒降至1.2秒"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.yss520.online/zh/posts/"},{"@type":"ListItem","position":2,"name":"现代前端架构设计与性能优化","item":"https://www.yss520.online/zh/posts/architecture-and-performance/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"现代前端架构设计与性能优化","name":"现代前端架构设计与性能优化","description":"从分形到原子的性能提升之旅：如何将一个大型React应用的首屏加载时间从8.6秒降至1.2秒","keywords":["架构设计","性能优化","React","前端工程化"],"articleBody":"现代前端架构设计与性能：从分形到原子的性能提升之旅 去年我负责重构了一个运行了 5 年的大型 B2B SaaS 平台。最初，它是一个单体 React 应用，代码超过 15 万行，运行缓慢且维护困难。经过 3 个月的架构重设计，我们将首屏加载时间从 8.6 秒降至 1.2 秒，内存使用减少 65%，交互响应从平均 600ms 提升至不到 100ms。更重要的是，开发效率提高了 3 倍，这种架构层面的优化影响深远，今天我想分享这段经历。\n现代架构模式与性能的隐秘关系 传统观点认为架构是为了可维护性，性能优化是单独的任务。实际上，正确的架构决策本身就能带来显著的性能提升。\n从巨石到微前端：拆分与懒加载的艺术 最初的单体应用含有超过 20 个主要业务模块，所有代码打包在一起，导致即使用户只需一个简单功能，也要加载整个应用：\n// 原始入口文件 - 所有模块一次性加载 import React from \"react\"; import ReactDOM from \"react-dom\"; import { BrowserRouter } from \"react-router-dom\"; import { Provider } from \"react-redux\"; // 导入所有模块 import Dashboard from \"./modules/dashboard\"; import Inventory from \"./modules/inventory\"; import Orders from \"./modules/orders\"; import Analytics from \"./modules/analytics\"; import Users from \"./modules/users\"; import Settings from \"./modules/settings\"; // ... 15个其他模块 import store from \"./store\"; import App from \"./App\"; ReactDOM.render( \u003cProvider store={store}\u003e \u003cBrowserRouter\u003e \u003cApp /\u003e \u003c/BrowserRouter\u003e \u003c/Provider\u003e, document.getElementById(\"root\") ); 这导致初始 JavaScript 包达到 5.8MB，即使经过压缩也有 1.6MB。我们决定采用微前端架构，但不是盲目跟风，而是根据业务边界精确划分：\n// 架构重构后的系统入口 - 使用Module Federation import React, { lazy, Suspense } from \"react\"; import ReactDOM from \"react-dom\"; import { BrowserRouter, Routes, Route } from \"react-router-dom\"; import { ErrorBoundary } from \"react-error-boundary\"; // 只导入核心Shell import Shell from \"./shell/Shell\"; import Loading from \"./components/Loading\"; import ErrorFallback from \"./components/ErrorFallback\"; // 动态导入各业务模块 const Dashboard = lazy(() =\u003e import(\"dashboard/Module\")); const Inventory = lazy(() =\u003e import(\"inventory/Module\")); const Orders = lazy(() =\u003e import(\"orders/Module\")); // 其他模块按需加载 ReactDOM.render( \u003cBrowserRouter\u003e \u003cErrorBoundary FallbackComponent={ErrorFallback}\u003e \u003cShell\u003e \u003cSuspense fallback={\u003cLoading /\u003e}\u003e \u003cRoutes\u003e \u003cRoute path=\"/\" element={\u003cDashboard /\u003e} /\u003e \u003cRoute path=\"/inventory/*\" element={\u003cInventory /\u003e} /\u003e \u003cRoute path=\"/orders/*\" element={\u003cOrders /\u003e} /\u003e {/* 其他路由 */} \u003c/Routes\u003e \u003c/Suspense\u003e \u003c/Shell\u003e \u003c/ErrorBoundary\u003e \u003c/BrowserRouter\u003e, document.getElementById(\"root\") ); 为实现模块间集成，我们使用 Webpack 5 的 Module Federation：\n// webpack.config.js - Shell应用配置 const { ModuleFederationPlugin } = require(\"webpack\").container; module.exports = { // 基础配置... plugins: [ new ModuleFederationPlugin({ name: \"shell\", filename: \"remoteEntry.js\", remotes: { dashboard: \"dashboard@http://localhost:3001/remoteEntry.js\", inventory: \"inventory@http://localhost:3002/remoteEntry.js\", orders: \"orders@http://localhost:3003/remoteEntry.js\", // 其他远程模块 }, shared: { react: { singleton: true, eager: true }, \"react-dom\": { singleton: true, eager: true }, \"react-router-dom\": { singleton: true }, // 其他共享依赖 }, }), ], }; 这个架构让我们实现了真正的按需加载 - 用户只下载他们访问的功能。首屏加载从 1.6MB 减少到 280KB，一个极大的改进。\n但微前端带来了新挑战：模块间通信和共享状态。\n状态管理重构：从单体到分形 传统 Redux 架构中，我们曾使用一个庞大的全局存储：\n// 原始的单体状态管理 import { createStore, combineReducers, applyMiddleware } from \"redux\"; import thunk from \"redux-thunk\"; import logger from \"redux-logger\"; // 导入所有模块的reducer import dashboardReducer from \"./modules/dashboard/reducer\"; import inventoryReducer from \"./modules/inventory/reducer\"; import ordersReducer from \"./modules/orders/reducer\"; import analyticsReducer from \"./modules/analytics/reducer\"; // ...更多reducer const rootReducer = combineReducers({ dashboard: dashboardReducer, inventory: inventoryReducer, orders: ordersReducer, analytics: analyticsReducer, // ...其他减速器 }); const store = createStore(rootReducer, applyMiddleware(thunk, logger)); export default store; 这种方法导致几个问题：\n所有状态逻辑都加载，即使未使用 状态更新导致不必要的组件重新渲染 不同团队修改可能相互冲突 我们引入了\"状态分形\"模式：\n// shell/stateManager.js - 状态管理协调器 import { createContext, useState, useContext, useEffect } from \"react\"; // 中央事件总线 const eventBus = { listeners: {}, subscribe(event, callback) { if (!this.listeners[event]) { this.listeners[event] = []; } this.listeners[event].push(callback); return () =\u003e this.unsubscribe(event, callback); }, unsubscribe(event, callback) { if (!this.listeners[event]) return; this.listeners[event] = this.listeners[event].filter( (listener) =\u003e listener !== callback ); }, publish(event, data) { if (!this.listeners[event]) return; this.listeners[event].forEach((callback) =\u003e callback(data)); }, }; // 创建状态上下文 const StateContext = createContext(null); // 全局状态只包含必要的共享数据 const initialGlobalState = { user: null, notifications: [], systemSettings: {}, }; // 状态提供者 export function StateProvider({ children }) { const [globalState, setGlobalState] = useState(initialGlobalState); // 更新全局状态的方法 const updateGlobalState = (key, value) =\u003e { setGlobalState((prev) =\u003e ({ ...prev, [key]: typeof value === \"function\" ? value(prev[key]) : value, })); // 发布状态变更事件 eventBus.publish(\"globalStateChange\", { key, value }); }; return ( \u003cStateContext.Provider value={{ globalState, updateGlobalState, eventBus, }} \u003e {children} \u003c/StateContext.Provider\u003e ); } // 全局状态钩子 export function useGlobalState() { const context = useContext(StateContext); if (!context) { throw new Error(\"useGlobalState must be used within StateProvider\"); } return context; } // 模块状态钩子 - 每个微前端使用 export function createModuleState(moduleName, initialState) { return function useModuleState() { const [moduleState, setModuleState] = useState(initialState); const { eventBus } = useGlobalState(); // 更新模块状态的方法 const updateModuleState = (key, value) =\u003e { setModuleState((prev) =\u003e ({ ...prev, [key]: typeof value === \"function\" ? value(prev[key]) : value, })); // 发布模块状态变更事件 eventBus.publish(`${moduleName}StateChange`, { key, value }); }; return { moduleState, updateModuleState }; }; } // 跨模块通信钩子 export function useModuleCommunication() { const { eventBus } = useGlobalState(); // 发送消息到其他模块 const sendMessage = (targetModule, messageType, data) =\u003e { eventBus.publish(`module:${targetModule}:${messageType}`, data); }; // 监听来自其他模块的消息 const listenToMessage = (messageType, callback) =\u003e { return eventBus.subscribe(`module:${messageType}`, callback); }; return { sendMessage, listenToMessage }; } 各微前端模块这样使用：\n// dashboard/Module.js import React from \"react\"; import { createModuleState, useGlobalState, useModuleCommunication, } from \"shell/stateManager\"; // 创建模块自己的状态 const useDashboardState = createModuleState(\"dashboard\", { metrics: [], filters: { period: \"week\", category: \"all\" }, isLoading: false, }); function Dashboard() { // 使用全局状态 const { globalState } = useGlobalState(); // 使用模块自己的状态 const { moduleState, updateModuleState } = useDashboardState(); // 模块间通信 const { sendMessage, listenToMessage } = useModuleCommunication(); // 监听来自库存模块的消息 React.useEffect(() =\u003e { const unsubscribe = listenToMessage(\"inventory:stockAlert\", (data) =\u003e { // 处理库存警报 updateModuleState(\"alerts\", (prev) =\u003e [...prev, data]); }); return unsubscribe; }, []); // 组件逻辑... } 这种架构带来几个好处：\n每个模块只加载自己的状态逻辑 状态更新只触发相关模块渲染 明确的通信界面减少冲突 全局状态只包含必要数据 重构后，状态管理相关的内存使用减少了约 60%，组件不必要的重新渲染减少了约 75%。\nAPI 层与数据获取策略 原应用有一个问题是数据获取没有策略，到处都是重复请求：\n// 原始数据获取 - 散布在组件中 function ProductList() { const [products, setProducts] = useState([]); const [loading, setLoading] = useState(false); useEffect(() =\u003e { setLoading(true); fetch(\"/api/products\") .then((res) =\u003e res.json()) .then((data) =\u003e { setProducts(data); setLoading(false); }) .catch((err) =\u003e { console.error(err); setLoading(false); }); }, []); // 组件代码... } // 同一个API在多个组件中重复调用 function ProductStats() { const [products, setProducts] = useState([]); useEffect(() =\u003e { fetch(\"/api/products\") .then((res) =\u003e res.json()) .then(setProducts); }, []); // 更多组件代码... } 我们设计了一个 API 层架构来集中管理数据获取：\n// api/core.js - API核心层 import { createCache } from \"../utils/cache\"; // 请求配置 const DEFAULT_TIMEOUT = 30000; const apiCache = createCache({ maxAge: 5 * 60 * 1000 }); // 默认缓存5分钟 // 基础请求函数 async function request(url, options = {}) { const { method = \"GET\", data, headers = {}, timeout = DEFAULT_TIMEOUT, cache = false, cacheKey, revalidate = false, } = options; // 生成缓存键 const effectiveCacheKey = cacheKey || `${method}:${url}:${JSON.stringify(data || {})}`; // 检查缓存 if (cache \u0026\u0026 !revalidate) { const cachedResponse = apiCache.get(effectiveCacheKey); if (cachedResponse) { return Promise.resolve(cachedResponse); } } // 设置请求超时 const controller = new AbortController(); const timeoutId = setTimeout(() =\u003e controller.abort(), timeout); try { const response = await fetch(url, { method, headers: { \"Content-Type\": \"application/json\", ...headers, }, body: data ? JSON.stringify(data) : undefined, signal: controller.signal, }); clearTimeout(timeoutId); // 处理错误状态码 if (!response.ok) { const error = await response.json().catch(() =\u003e ({})); throw new Error( error.message || `Request failed with status ${response.status}` ); } const result = await response.json(); // 如果需要缓存，存储结果 if (cache) { apiCache.set(effectiveCacheKey, result); } return result; } catch (error) { clearTimeout(timeoutId); // 重新抛出错误，保留原始堆栈 if (error.name === \"AbortError\") { throw new Error(`Request timeout after ${timeout}ms`); } throw error; } } // 导出请求方法 export const api = { get: (url, options) =\u003e request(url, { ...options, method: \"GET\" }), post: (url, data, options) =\u003e request(url, { ...options, method: \"POST\", data }), put: (url, data, options) =\u003e request(url, { ...options, method: \"PUT\", data }), delete: (url, options) =\u003e request(url, { ...options, method: \"DELETE\" }), // 获取请求状态 invalidateCache: (cacheKey) =\u003e { apiCache.delete(cacheKey); }, clearCache: () =\u003e { apiCache.clear(); }, }; 然后为每个业务领域创建专用数据服务：\n// api/products.js - 产品领域API import { api } from \"./core\"; import { useMutation, useQuery } from \"../hooks/api\"; // 基础端点 const BASE_URL = \"/api/products\"; // 产品API方法 export const productApi = { // 获取产品列表 getProducts: (filters = {}) =\u003e { const queryString = new URLSearchParams(filters).toString(); const url = `${BASE_URL}${queryString ? `?${queryString}` : \"\"}`; return api.get(url, { cache: true }); }, // 获取单个产品 getProduct: (id) =\u003e { return api.get(`${BASE_URL}/${id}`, { cache: true }); }, // 创建产品 createProduct: (data) =\u003e { return api.post(BASE_URL, data); }, // 更新产品 updateProduct: (id, data) =\u003e { return api.put(`${BASE_URL}/${id}`, data); }, // 删除产品 deleteProduct: (id) =\u003e { return api.delete(`${BASE_URL}/${id}`); }, // 重新验证缓存 invalidateProducts: () =\u003e { api.invalidateCache((key) =\u003e key.startsWith(\"GET:\" + BASE_URL)); }, }; // React Hooks for products export function useProducts(filters = {}, options = {}) { return useQuery( [\"products\", filters], () =\u003e productApi.getProducts(filters), options ); } export function useProduct(id, options = {}) { return useQuery([\"product\", id], () =\u003e productApi.getProduct(id), options); } export function useCreateProduct() { return useMutation((data) =\u003e productApi.createProduct(data), { onSuccess: () =\u003e { // 自动重新验证产品列表 productApi.invalidateProducts(); }, }); } // 更多数据操作钩子... 配套设计了自定义钩子来简化数据获取：\n// hooks/api.js - 数据获取钩子 import { useState, useEffect, useCallback, useRef } from \"react\"; // 简化版的查询钩子 export function useQuery(queryKey, queryFn, options = {}) { const { enabled = true, retry = 3, retryDelay = 1000, onSuccess, onError, initialData, staleTime = 0, // 数据有效期 } = options; // 状态管理 const [data, setData] = useState(initialData); const [error, setError] = useState(null); const [status, setStatus] = useState(\"idle\"); // 引用值 const queryKeyRef = useRef(JSON.stringify(queryKey)); const fetchTimestampRef = useRef(0); const retryCountRef = useRef(0); // 当前查询是否过期 const isStale = useCallback(() =\u003e { if (staleTime === 0) return true; return Date.now() - fetchTimestampRef.current \u003e staleTime; }, [staleTime]); // 执行查询 const execute = useCallback(async () =\u003e { // 避免重复查询 if (status === \"loading\") return; // 如果数据未过期且存在，不执行查询 if (data \u0026\u0026 !isStale()) return; setStatus(\"loading\"); retryCountRef.current = 0; const fetchData = async () =\u003e { try { const result = await queryFn(); setData(result); setError(null); setStatus(\"success\"); fetchTimestampRef.current = Date.now(); if (onSuccess) onSuccess(result); } catch (err) { // 重试逻辑 if (retryCountRef.current \u003c retry) { retryCountRef.current++; const delay = typeof retryDelay === \"function\" ? retryDelay(retryCountRef.current) : retryDelay; setTimeout(fetchData, delay); } else { setError(err); setStatus(\"error\"); if (onError) onError(err); } } }; fetchData(); }, [data, isStale, onError, onSuccess, queryFn, retry, retryDelay, status]); // 初始请求和查询键变更时请求 useEffect(() =\u003e { const currentQueryKey = JSON.stringify(queryKey); if (queryKeyRef.current !== currentQueryKey) { queryKeyRef.current = currentQueryKey; // 查询键变化，重置状态 setStatus(\"idle\"); setData(initialData); setError(null); } if (enabled) { execute(); } }, [queryKeyRef.current, enabled, execute, initialData]); // 刷新数据的方法 const refetch = useCallback(() =\u003e { return execute(); }, [execute]); return { data, error, isLoading: status === \"loading\", isSuccess: status === \"success\", isError: status === \"error\", refetch, }; } // 数据变更钩子 export function useMutation(mutationFn, options = {}) { const { onSuccess, onError, onSettled } = options; const [state, setState] = useState({ isLoading: false, isSuccess: false, isError: false, error: null, data: undefined, }); const reset = useCallback(() =\u003e { setState({ isLoading: false, isSuccess: false, isError: false, error: null, data: undefined, }); }, []); const mutate = useCallback( async (variables) =\u003e { setState({ ...state, isLoading: true }); try { const data = await mutationFn(variables); setState({ isLoading: false, isSuccess: true, isError: false, error: null, data, }); if (onSuccess) { onSuccess(data, variables); } if (onSettled) { onSettled(data, null, variables); } return data; } catch (error) { setState({ isLoading: false, isSuccess: false, isError: true, error, data: undefined, }); if (onError) { onError(error, variables); } if (onSettled) { onSettled(undefined, error, variables); } throw error; } }, [mutationFn, onError, onSettled, onSuccess, state] ); return { ...state, mutate, reset, }; } 这种架构大大改进了数据获取效率：\n自动缓存减少重复请求 统一错误处理和重试逻辑 响应式数据更新 自动数据失效 重构后，API 请求数量减少了约 70%，数据加载时间减少了约 55%。\n代码分割与懒加载战略 传统前端应用通常只考虑路由级别的代码分割，但我们更进一步：\n// 组件级别代码分割 import React, { lazy, Suspense } from \"react\"; import Loading from \"../../components/Loading\"; // 基于业务规则的高级懒加载 function lazyWithPreload(factory) { const Component = lazy(factory); Component.preload = factory; return Component; } // 复杂仪表板组件按需加载 const DashboardMetrics = lazyWithPreload(() =\u003e import(\"./DashboardMetrics\")); const RevenueChart = lazyWithPreload(() =\u003e import(\"./RevenueChart\")); const OrdersTable = lazyWithPreload(() =\u003e import(\"./OrdersTable\")); const CustomerMap = lazyWithPreload(() =\u003e import(\"./CustomerMap\")); // 基于用户角色决定是否预加载 function Dashboard({ userRole }) { const [activeTab, setActiveTab] = useState(\"overview\"); // 预加载策略 useEffect(() =\u003e { // 管理员用户预加载所有组件 if (userRole === \"admin\") { DashboardMetrics.preload(); RevenueChart.preload(); OrdersTable.preload(); CustomerMap.preload(); } else { // 普通用户只预加载基础组件 DashboardMetrics.preload(); } }, [userRole]); // 当用户将鼠标悬停在选项卡上时预加载对应组件 const handleTabHover = (tab) =\u003e { if (tab === \"revenue\" \u0026\u0026 activeTab !== \"revenue\") { RevenueChart.preload(); } else if (tab === \"orders\" \u0026\u0026 activeTab !== \"orders\") { OrdersTable.preload(); } else if (tab === \"customers\" \u0026\u0026 activeTab !== \"customers\") { CustomerMap.preload(); } }; return ( \u003cdiv className=\"dashboard\"\u003e \u003cnav className=\"dashboard-tabs\"\u003e \u003cbutton className={activeTab === \"overview\" ? \"active\" : \"\"} onClick={() =\u003e setActiveTab(\"overview\")} \u003e Overview \u003c/button\u003e \u003cbutton className={activeTab === \"revenue\" ? \"active\" : \"\"} onClick={() =\u003e setActiveTab(\"revenue\")} onMouseEnter={() =\u003e handleTabHover(\"revenue\")} \u003e Revenue \u003c/button\u003e {/* 其他选项卡 */} \u003c/nav\u003e \u003cdiv className=\"dashboard-content\"\u003e {activeTab === \"overview\" \u0026\u0026 ( \u003cSuspense fallback={\u003cLoading /\u003e}\u003e \u003cDashboardMetrics /\u003e \u003c/Suspense\u003e )} {activeTab === \"revenue\" \u0026\u0026 ( \u003cSuspense fallback={\u003cLoading /\u003e}\u003e \u003cRevenueChart /\u003e \u003c/Suspense\u003e )} {/* 其他内容 */} \u003c/div\u003e \u003c/div\u003e ); } 我们甚至对组件库做了更精细的拆分：\n// 按需加载的组件库 // components/index.js export { Button } from \"./Button\"; export { Card } from \"./Card\"; export { Table } from \"./Table\"; // ...避免一次导入所有组件 // 使用示例 - 只导入需要的组件 import { Button, Card } from \"../components\"; // 而不是 import * from '../components'; 这种拆分策略将初始加载的组件库代码减少了约 85%，实现了真正的按需加载。\n渐进式架构迁移策略 对于大型遗留应用，我们开发了一种\"容器模式\"，实现渐进式微前端迁移：\n// 遗留应用包装器 import React, { useEffect, useRef } from \"react\"; // 包装旧应用的容器 export function LegacyAppContainer({ route, onNavigate }) { const containerRef = useRef(null); useEffect(() =\u003e { if (!containerRef.current) return; // 注入旧应用 const clean = mountLegacyApp(containerRef.current, { initialRoute: route, onNavigate: (newRoute) =\u003e { // 当旧应用导航时通知新架构 if (onNavigate) onNavigate(newRoute); }, }); return () =\u003e { // 清理旧应用 if (clean) clean(); }; }, [route, onNavigate]); return \u003cdiv className=\"legacy-container\" ref={containerRef} /\u003e; } // 在旧应用中注入通信桥接器 function mountLegacyApp(container, options) { const { initialRoute, onNavigate } = options; // 加载旧应用脚本 const script = document.createElement(\"script\"); script.src = \"/legacy-app.js\"; document.head.appendChild(script); return new Promise((resolve) =\u003e { // 等待旧应用加载完成 window.onLegacyAppLoaded = () =\u003e { // 初始化旧应用 window.legacyApp.init(container, initialRoute); // 监听旧应用导航 window.legacyApp.onNavigate = onNavigate; // 返回清理函数 resolve(() =\u003e { window.legacyApp.unmount(); container.innerHTML = \"\"; }); }; }); } 这种方式让我们能够增量迁移，而不是一次性重写整个应用。\n构建优化与部署策略 除了前端架构，我们还优化了构建系统：\n// webpack.prod.js - 优化生产构建 const { BundleAnalyzerPlugin } = require(\"webpack-bundle-analyzer\"); const CompressionPlugin = require(\"compression-webpack-plugin\"); const TerserPlugin = require(\"terser-webpack-plugin\"); module.exports = { // 基础配置... optimization: { minimizer: [ new TerserPlugin({ terserOptions: { compress: { drop_console: true, }, }, extractComments: false, }), ], splitChunks: { chunks: \"all\", maxInitialRequests: 25, minSize: 20000, cacheGroups: { vendors: { test: /[\\\\/]node_modules[\\\\/]/, name(module) { // 为每个npm包创建单独的chunk const packageName = module.context.match( /[\\\\/]node_modules[\\\\/](.*?)([\\\\/]|$)/ )[1]; return `npm.${packageName.replace(\"@\", \"\")}`; }, }, common: { minChunks: 2, priority: -10, reuseExistingChunk: true, }, }, }, }, plugins: [ // 其他插件... new CompressionPlugin({ algorithm: \"gzip\", test: /\\.(js|css|html|svg)$/, threshold: 10240, minRatio: 0.8, }), process.env.ANALYZE \u0026\u0026 new BundleAnalyzerPlugin(), ].filter(Boolean), }; 我们还采用了增量部署策略，只更新变更的模块，大大减少了部署时间和风险。\n实际性能改进数据 架构重构取得了显著成效:\n指标 重构前 重构后 改进率 首屏加载时间 8.6s 1.2s 86% 初始 JS 体积 1.6MB 280KB 83% 内存使用 平均 215MB 平均 76MB 65% 交互响应时间 平均 600ms \u003c100ms 83% API 请求数 ~120 次/页面 ~35 次/页面 71% 开发迭代周期 2 周 4 天 71% 更重要的是，系统可维护性大幅提升，新功能开发速度提高了 3 倍。\n架构优化的关键教训 总结这次重构的关键经验：\n业务边界优先于技术边界: 按照业务域而非技术层分割应用，使团队能专注于完整功能而非技术层\n状态是首要性能瓶颈: 大型应用中，状态管理比渲染优化更能影响性能\n仅按需加载，甚至连框架也是: 对 React 等基础库应用代码分割，只加载必要部分\n数据获取策略是隐藏的金矿: 优化 API 调用模式常常比优化组件渲染更有效\n渐进增强胜过全面重构: 使用容器模式渐进迁移，而非一次性大规模重写\n监控和衡量是关键: 没有数据支持的架构决策往往是错误的\n架构性能的未来趋势 通过这个项目，我观察到几个值得关注的前端架构趋势：\n服务器组件：React Server Components 等技术进一步模糊前后端边界\n细粒度包管理：ES 模块和 Import Maps 让浏览器直接管理依赖成为可能\n静态生成与增量静态再生：越来越多内容前置到构建时，而非运行时\n边缘计算：将渲染逻辑推向 CDN 边缘，减少延迟\n我们已经开始在项目中实验性地应用这些技术，未来的架构将更倾向于\"分布式渲染\"，而非传统的客户端/服务器二分法。\n结语 前端架构设计与性能优化不是独立的关注点，而是密不可分的整体。正确的架构决策本身就能带来巨大的性能提升，无需事后优化。\n通过拆分巨石应用为微前端、重构状态管理、优化数据获取策略和实施智能代码分割，我们不仅显著提升了应用性能，还改善了开发体验和系统可维护性。\n架构层面的优化提供了比组件级优化更持久、更深远的价值。正如我们在这个项目中所证明的，思考系统的分形结构，从整体到局部，能带来超出预期的性能改进。\n无论你是构建全新应用还是改进现有系统，记住这一点：伟大的性能始于伟大的架构，二者相辅相成，共同构建卓越的用户体验。\n相关阅读 Vite 构建 React 项目的极致优化 - 了解如何优化前端构建流程 React 虚拟 DOM 深度剖析 - 深入理解 React 渲染机制 现代前端工程化实践指南 - 探索更多工程化最佳实践 ","wordCount":"2224","inLanguage":"zh","image":"https://www.yss520.online/images/real-covers/architecture.jpg","datePublished":"2023-07-25T22:13:24+08:00","dateModified":"2023-07-25T22:13:24+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.yss520.online/zh/posts/architecture-and-performance/"},"publisher":{"@type":"Organization","name":"Bruce的博客","logo":{"@type":"ImageObject","url":"https://www.yss520.online/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.yss520.online/zh/ accesskey=h title="Bruce的博客 (Alt + H)">Bruce的博客</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://www.yss520.online/en/ title=English aria-label=English>En</a></li></ul></div></div><ul id=menu><li><a href=https://www.yss520.online/zh/ title=首页><span>首页</span></a></li><li><a href=https://www.yss520.online/zh/posts/ title=博客><span>博客</span></a></li><li><a href=https://www.yss520.online/zh/tags/ title=标签><span>标签</span></a></li><li><a href=https://www.yss520.online/zh/categories/ title=分类><span>分类</span></a></li><li><a href=https://www.yss520.online/zh/projects/ title=项目><span>项目</span></a></li><li><a href=https://www.yss520.online/zh/gallery/ title=画廊><span>画廊</span></a></li><li><a href=https://www.yss520.online/zh/about/ title=关于><span>关于</span></a></li><li><a href=https://www.yss520.online/zh/contact/ title=联系><span>联系</span></a></li><li><a href=https://www.yss520.online/zh/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.yss520.online/zh/>主页</a>&nbsp;»&nbsp;<a href=https://www.yss520.online/zh/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">现代前端架构设计与性能优化</h1><div class=post-description>从分形到原子的性能提升之旅：如何将一个大型React应用的首屏加载时间从8.6秒降至1.2秒</div><div class=post-meta><span title='2023-07-25 22:13:24 +0800 +0800'>七月 25, 2023</span>&nbsp;·&nbsp;11 分钟&nbsp;·&nbsp;2224 字</div></header><figure class=entry-cover><img loading=eager src=https://www.yss520.online/images/real-covers/architecture.jpg alt=现代前端架构设计><figcaption>从单体应用到微前端的性能提升之旅</figcaption></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e7%8e%b0%e4%bb%a3%e5%89%8d%e7%ab%af%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e4%b8%8e%e6%80%a7%e8%83%bd%e4%bb%8e%e5%88%86%e5%bd%a2%e5%88%b0%e5%8e%9f%e5%ad%90%e7%9a%84%e6%80%a7%e8%83%bd%e6%8f%90%e5%8d%87%e4%b9%8b%e6%97%85 aria-label=现代前端架构设计与性能：从分形到原子的性能提升之旅>现代前端架构设计与性能：从分形到原子的性能提升之旅</a><ul><li><a href=#%e7%8e%b0%e4%bb%a3%e6%9e%b6%e6%9e%84%e6%a8%a1%e5%bc%8f%e4%b8%8e%e6%80%a7%e8%83%bd%e7%9a%84%e9%9a%90%e7%a7%98%e5%85%b3%e7%b3%bb aria-label=现代架构模式与性能的隐秘关系>现代架构模式与性能的隐秘关系</a><ul><li><a href=#%e4%bb%8e%e5%b7%a8%e7%9f%b3%e5%88%b0%e5%be%ae%e5%89%8d%e7%ab%af%e6%8b%86%e5%88%86%e4%b8%8e%e6%87%92%e5%8a%a0%e8%bd%bd%e7%9a%84%e8%89%ba%e6%9c%af aria-label=从巨石到微前端：拆分与懒加载的艺术>从巨石到微前端：拆分与懒加载的艺术</a></li></ul></li><li><a href=#%e7%8a%b6%e6%80%81%e7%ae%a1%e7%90%86%e9%87%8d%e6%9e%84%e4%bb%8e%e5%8d%95%e4%bd%93%e5%88%b0%e5%88%86%e5%bd%a2 aria-label=状态管理重构：从单体到分形>状态管理重构：从单体到分形</a></li><li><a href=#api-%e5%b1%82%e4%b8%8e%e6%95%b0%e6%8d%ae%e8%8e%b7%e5%8f%96%e7%ad%96%e7%95%a5 aria-label="API 层与数据获取策略">API 层与数据获取策略</a></li><li><a href=#%e4%bb%a3%e7%a0%81%e5%88%86%e5%89%b2%e4%b8%8e%e6%87%92%e5%8a%a0%e8%bd%bd%e6%88%98%e7%95%a5 aria-label=代码分割与懒加载战略>代码分割与懒加载战略</a></li><li><a href=#%e6%b8%90%e8%bf%9b%e5%bc%8f%e6%9e%b6%e6%9e%84%e8%bf%81%e7%a7%bb%e7%ad%96%e7%95%a5 aria-label=渐进式架构迁移策略>渐进式架构迁移策略</a></li><li><a href=#%e6%9e%84%e5%bb%ba%e4%bc%98%e5%8c%96%e4%b8%8e%e9%83%a8%e7%bd%b2%e7%ad%96%e7%95%a5 aria-label=构建优化与部署策略>构建优化与部署策略</a></li><li><a href=#%e5%ae%9e%e9%99%85%e6%80%a7%e8%83%bd%e6%94%b9%e8%bf%9b%e6%95%b0%e6%8d%ae aria-label=实际性能改进数据>实际性能改进数据</a></li><li><a href=#%e6%9e%b6%e6%9e%84%e4%bc%98%e5%8c%96%e7%9a%84%e5%85%b3%e9%94%ae%e6%95%99%e8%ae%ad aria-label=架构优化的关键教训>架构优化的关键教训</a></li><li><a href=#%e6%9e%b6%e6%9e%84%e6%80%a7%e8%83%bd%e7%9a%84%e6%9c%aa%e6%9d%a5%e8%b6%8b%e5%8a%bf aria-label=架构性能的未来趋势>架构性能的未来趋势</a></li><li><a href=#%e7%bb%93%e8%af%ad aria-label=结语>结语</a></li><li><a href=#%e7%9b%b8%e5%85%b3%e9%98%85%e8%af%bb aria-label=相关阅读>相关阅读</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=现代前端架构设计与性能从分形到原子的性能提升之旅>现代前端架构设计与性能：从分形到原子的性能提升之旅<a hidden class=anchor aria-hidden=true href=#现代前端架构设计与性能从分形到原子的性能提升之旅>#</a></h1><p>去年我负责重构了一个运行了 5 年的大型 B2B SaaS 平台。最初，它是一个单体 React 应用，代码超过 15 万行，运行缓慢且维护困难。经过 3 个月的架构重设计，我们将首屏加载时间从 8.6 秒降至 1.2 秒，内存使用减少 65%，交互响应从平均 600ms 提升至不到 100ms。更重要的是，开发效率提高了 3 倍，这种架构层面的优化影响深远，今天我想分享这段经历。</p><h2 id=现代架构模式与性能的隐秘关系>现代架构模式与性能的隐秘关系<a hidden class=anchor aria-hidden=true href=#现代架构模式与性能的隐秘关系>#</a></h2><p>传统观点认为架构是为了可维护性，性能优化是单独的任务。实际上，正确的架构决策本身就能带来显著的性能提升。</p><h3 id=从巨石到微前端拆分与懒加载的艺术>从巨石到微前端：拆分与懒加载的艺术<a hidden class=anchor aria-hidden=true href=#从巨石到微前端拆分与懒加载的艺术>#</a></h3><p>最初的单体应用含有超过 20 个主要业务模块，所有代码打包在一起，导致即使用户只需一个简单功能，也要加载整个应用：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 原始入口文件 - 所有模块一次性加载
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>React</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>ReactDOM</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react-dom&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>BrowserRouter</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react-router-dom&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Provider</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react-redux&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 导入所有模块
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Dashboard</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./modules/dashboard&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Inventory</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./modules/inventory&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Orders</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./modules/orders&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Analytics</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./modules/analytics&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Users</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./modules/users&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Settings</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./modules/settings&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>// ... 15个其他模块
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>store</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./store&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>App</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./App&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ReactDOM</span>.<span style=color:#a6e22e>render</span>(
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Provider</span> <span style=color:#a6e22e>store</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>store</span>}<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>BrowserRouter</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>App</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/BrowserRouter&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/Provider&gt;,</span>
</span></span><span style=display:flex><span>  document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#34;root&#34;</span>)
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>这导致初始 JavaScript 包达到 5.8MB，即使经过压缩也有 1.6MB。我们决定采用微前端架构，但不是盲目跟风，而是根据业务边界精确划分：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 架构重构后的系统入口 - 使用Module Federation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>React</span>, { <span style=color:#a6e22e>lazy</span>, <span style=color:#a6e22e>Suspense</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>ReactDOM</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react-dom&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>BrowserRouter</span>, <span style=color:#a6e22e>Routes</span>, <span style=color:#a6e22e>Route</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react-router-dom&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ErrorBoundary</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react-error-boundary&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 只导入核心Shell
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Shell</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./shell/Shell&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Loading</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./components/Loading&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>ErrorFallback</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./components/ErrorFallback&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 动态导入各业务模块
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Dashboard</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>lazy</span>(() =&gt; <span style=color:#66d9ef>import</span>(<span style=color:#e6db74>&#34;dashboard/Module&#34;</span>));
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Inventory</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>lazy</span>(() =&gt; <span style=color:#66d9ef>import</span>(<span style=color:#e6db74>&#34;inventory/Module&#34;</span>));
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Orders</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>lazy</span>(() =&gt; <span style=color:#66d9ef>import</span>(<span style=color:#e6db74>&#34;orders/Module&#34;</span>));
</span></span><span style=display:flex><span><span style=color:#75715e>// 其他模块按需加载
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ReactDOM</span>.<span style=color:#a6e22e>render</span>(
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>BrowserRouter</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>ErrorBoundary</span> <span style=color:#a6e22e>FallbackComponent</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>ErrorFallback</span>}<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Shell</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Suspense</span> <span style=color:#a6e22e>fallback</span><span style=color:#f92672>=</span>{<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Loading</span> <span style=color:#f92672>/&gt;</span>}<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Routes</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Route</span> <span style=color:#a6e22e>path</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#a6e22e>element</span><span style=color:#f92672>=</span>{<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Dashboard</span> <span style=color:#f92672>/&gt;</span>} <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Route</span> <span style=color:#a6e22e>path</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/inventory/*&#34;</span> <span style=color:#a6e22e>element</span><span style=color:#f92672>=</span>{<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Inventory</span> <span style=color:#f92672>/&gt;</span>} <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Route</span> <span style=color:#a6e22e>path</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/orders/*&#34;</span> <span style=color:#a6e22e>element</span><span style=color:#f92672>=</span>{<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Orders</span> <span style=color:#f92672>/&gt;</span>} <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>            {<span style=color:#75715e>/* 其他路由 */</span>}
</span></span><span style=display:flex><span>          <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/Routes&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/Suspense&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/Shell&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/ErrorBoundary&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/BrowserRouter&gt;,</span>
</span></span><span style=display:flex><span>  document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#34;root&#34;</span>)
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>为实现模块间集成，我们使用 Webpack 5 的 Module Federation：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// webpack.config.js - Shell应用配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>ModuleFederationPlugin</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;webpack&#34;</span>).<span style=color:#a6e22e>container</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 基础配置...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>plugins</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ModuleFederationPlugin</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;shell&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;remoteEntry.js&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>remotes</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>dashboard</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;dashboard@http://localhost:3001/remoteEntry.js&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>inventory</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;inventory@http://localhost:3002/remoteEntry.js&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>orders</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;orders@http://localhost:3003/remoteEntry.js&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 其他远程模块
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>shared</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>react</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>singleton</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>eager</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;react-dom&#34;</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>singleton</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>eager</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;react-router-dom&#34;</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>singleton</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> },
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 其他共享依赖
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      },
</span></span><span style=display:flex><span>    }),
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>这个架构让我们实现了真正的按需加载 - 用户只下载他们访问的功能。首屏加载从 1.6MB 减少到 280KB，一个极大的改进。</p><p>但微前端带来了新挑战：模块间通信和共享状态。</p><h2 id=状态管理重构从单体到分形>状态管理重构：从单体到分形<a hidden class=anchor aria-hidden=true href=#状态管理重构从单体到分形>#</a></h2><p>传统 Redux 架构中，我们曾使用一个庞大的全局存储：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 原始的单体状态管理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>createStore</span>, <span style=color:#a6e22e>combineReducers</span>, <span style=color:#a6e22e>applyMiddleware</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;redux&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>thunk</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;redux-thunk&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>logger</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;redux-logger&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 导入所有模块的reducer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>dashboardReducer</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./modules/dashboard/reducer&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>inventoryReducer</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./modules/inventory/reducer&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>ordersReducer</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./modules/orders/reducer&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>analyticsReducer</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./modules/analytics/reducer&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>// ...更多reducer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>rootReducer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>combineReducers</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>dashboard</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>dashboardReducer</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>inventory</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>inventoryReducer</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>orders</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>ordersReducer</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>analytics</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>analyticsReducer</span>,
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...其他减速器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>store</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createStore</span>(<span style=color:#a6e22e>rootReducer</span>, <span style=color:#a6e22e>applyMiddleware</span>(<span style=color:#a6e22e>thunk</span>, <span style=color:#a6e22e>logger</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>store</span>;
</span></span></code></pre></div><p>这种方法导致几个问题：</p><ol><li>所有状态逻辑都加载，即使未使用</li><li>状态更新导致不必要的组件重新渲染</li><li>不同团队修改可能相互冲突</li></ol><p>我们引入了"状态分形"模式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// shell/stateManager.js - 状态管理协调器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>createContext</span>, <span style=color:#a6e22e>useState</span>, <span style=color:#a6e22e>useContext</span>, <span style=color:#a6e22e>useEffect</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 中央事件总线
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>eventBus</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>listeners</span><span style=color:#f92672>:</span> {},
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>subscribe</span>(<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>callback</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>listeners</span>[<span style=color:#a6e22e>event</span>]) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>listeners</span>[<span style=color:#a6e22e>event</span>] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>listeners</span>[<span style=color:#a6e22e>event</span>].<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>callback</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> () =&gt; <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>unsubscribe</span>(<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>callback</span>);
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>unsubscribe</span>(<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>callback</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>listeners</span>[<span style=color:#a6e22e>event</span>]) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>listeners</span>[<span style=color:#a6e22e>event</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>listeners</span>[<span style=color:#a6e22e>event</span>].<span style=color:#a6e22e>filter</span>(
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>listener</span>) =&gt; <span style=color:#a6e22e>listener</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>callback</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>publish</span>(<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>data</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>listeners</span>[<span style=color:#a6e22e>event</span>]) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>listeners</span>[<span style=color:#a6e22e>event</span>].<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>callback</span>) =&gt; <span style=color:#a6e22e>callback</span>(<span style=color:#a6e22e>data</span>));
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 创建状态上下文
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>StateContext</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createContext</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 全局状态只包含必要的共享数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>initialGlobalState</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>user</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>notifications</span><span style=color:#f92672>:</span> [],
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>systemSettings</span><span style=color:#f92672>:</span> {},
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 状态提供者
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>StateProvider</span>({ <span style=color:#a6e22e>children</span> }) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>globalState</span>, <span style=color:#a6e22e>setGlobalState</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>(<span style=color:#a6e22e>initialGlobalState</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 更新全局状态的方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>updateGlobalState</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setGlobalState</span>((<span style=color:#a6e22e>prev</span>) =&gt; ({
</span></span><span style=display:flex><span>      ...<span style=color:#a6e22e>prev</span>,
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>key</span>]<span style=color:#f92672>:</span> <span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>value</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;function&#34;</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>value</span>(<span style=color:#a6e22e>prev</span>[<span style=color:#a6e22e>key</span>]) <span style=color:#f92672>:</span> <span style=color:#a6e22e>value</span>,
</span></span><span style=display:flex><span>    }));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 发布状态变更事件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>eventBus</span>.<span style=color:#a6e22e>publish</span>(<span style=color:#e6db74>&#34;globalStateChange&#34;</span>, { <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span> });
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>StateContext</span>.<span style=color:#a6e22e>Provider</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span>{{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>globalState</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>updateGlobalState</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>eventBus</span>,
</span></span><span style=display:flex><span>      }}
</span></span><span style=display:flex><span>    <span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      {<span style=color:#a6e22e>children</span>}
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/StateContext.Provider&gt;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 全局状态钩子
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>useGlobalState</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>context</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useContext</span>(<span style=color:#a6e22e>StateContext</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>context</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#34;useGlobalState must be used within StateProvider&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>context</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 模块状态钩子 - 每个微前端使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>createModuleState</span>(<span style=color:#a6e22e>moduleName</span>, <span style=color:#a6e22e>initialState</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>useModuleState</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>moduleState</span>, <span style=color:#a6e22e>setModuleState</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>(<span style=color:#a6e22e>initialState</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>eventBus</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>useGlobalState</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 更新模块状态的方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>updateModuleState</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>setModuleState</span>((<span style=color:#a6e22e>prev</span>) =&gt; ({
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>prev</span>,
</span></span><span style=display:flex><span>        [<span style=color:#a6e22e>key</span>]<span style=color:#f92672>:</span> <span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>value</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;function&#34;</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>value</span>(<span style=color:#a6e22e>prev</span>[<span style=color:#a6e22e>key</span>]) <span style=color:#f92672>:</span> <span style=color:#a6e22e>value</span>,
</span></span><span style=display:flex><span>      }));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 发布模块状态变更事件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>eventBus</span>.<span style=color:#a6e22e>publish</span>(<span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>moduleName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>StateChange`</span>, { <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span> });
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>moduleState</span>, <span style=color:#a6e22e>updateModuleState</span> };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 跨模块通信钩子
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>useModuleCommunication</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>eventBus</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>useGlobalState</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 发送消息到其他模块
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sendMessage</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>targetModule</span>, <span style=color:#a6e22e>messageType</span>, <span style=color:#a6e22e>data</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>eventBus</span>.<span style=color:#a6e22e>publish</span>(<span style=color:#e6db74>`module:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>targetModule</span><span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>messageType</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>data</span>);
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 监听来自其他模块的消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>listenToMessage</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>messageType</span>, <span style=color:#a6e22e>callback</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>eventBus</span>.<span style=color:#a6e22e>subscribe</span>(<span style=color:#e6db74>`module:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>messageType</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>callback</span>);
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>sendMessage</span>, <span style=color:#a6e22e>listenToMessage</span> };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>各微前端模块这样使用：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// dashboard/Module.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>React</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>createModuleState</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>useGlobalState</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>useModuleCommunication</span>,
</span></span><span style=display:flex><span>} <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;shell/stateManager&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 创建模块自己的状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>useDashboardState</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createModuleState</span>(<span style=color:#e6db74>&#34;dashboard&#34;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>metrics</span><span style=color:#f92672>:</span> [],
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>filters</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>period</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;week&#34;</span>, <span style=color:#a6e22e>category</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;all&#34;</span> },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>isLoading</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Dashboard</span>() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 使用全局状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>globalState</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>useGlobalState</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 使用模块自己的状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>moduleState</span>, <span style=color:#a6e22e>updateModuleState</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>useDashboardState</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 模块间通信
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>sendMessage</span>, <span style=color:#a6e22e>listenToMessage</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>useModuleCommunication</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 监听来自库存模块的消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>React</span>.<span style=color:#a6e22e>useEffect</span>(() =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>unsubscribe</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>listenToMessage</span>(<span style=color:#e6db74>&#34;inventory:stockAlert&#34;</span>, (<span style=color:#a6e22e>data</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 处理库存警报
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>updateModuleState</span>(<span style=color:#e6db74>&#34;alerts&#34;</span>, (<span style=color:#a6e22e>prev</span>) =&gt; [...<span style=color:#a6e22e>prev</span>, <span style=color:#a6e22e>data</span>]);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>unsubscribe</span>;
</span></span><span style=display:flex><span>  }, []);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 组件逻辑...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>这种架构带来几个好处：</p><ol><li>每个模块只加载自己的状态逻辑</li><li>状态更新只触发相关模块渲染</li><li>明确的通信界面减少冲突</li><li>全局状态只包含必要数据</li></ol><p>重构后，状态管理相关的内存使用减少了约 60%，组件不必要的重新渲染减少了约 75%。</p><h2 id=api-层与数据获取策略>API 层与数据获取策略<a hidden class=anchor aria-hidden=true href=#api-层与数据获取策略>#</a></h2><p>原应用有一个问题是数据获取没有策略，到处都是重复请求：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 原始数据获取 - 散布在组件中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>ProductList</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>products</span>, <span style=color:#a6e22e>setProducts</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>([]);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>loading</span>, <span style=color:#a6e22e>setLoading</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>useEffect</span>(() =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setLoading</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>&#34;/api/products&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>res</span>) =&gt; <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>())
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>data</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>setProducts</span>(<span style=color:#a6e22e>data</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>setLoading</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>      })
</span></span><span style=display:flex><span>      .<span style=color:#66d9ef>catch</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>setLoading</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  }, []);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 组件代码...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 同一个API在多个组件中重复调用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>ProductStats</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>products</span>, <span style=color:#a6e22e>setProducts</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>([]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>useEffect</span>(() =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>&#34;/api/products&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>res</span>) =&gt; <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>())
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>setProducts</span>);
</span></span><span style=display:flex><span>  }, []);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 更多组件代码...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>我们设计了一个 API 层架构来集中管理数据获取：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// api/core.js - API核心层
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>createCache</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../utils/cache&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 请求配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>DEFAULT_TIMEOUT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>30000</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>apiCache</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createCache</span>({ <span style=color:#a6e22e>maxAge</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span> }); <span style=color:#75715e>// 默认缓存5分钟
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 基础请求函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>url</span>, <span style=color:#a6e22e>options</span> <span style=color:#f92672>=</span> {}) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>method</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>headers</span> <span style=color:#f92672>=</span> {},
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>timeout</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>DEFAULT_TIMEOUT</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cache</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cacheKey</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>revalidate</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>  } <span style=color:#f92672>=</span> <span style=color:#a6e22e>options</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 生成缓存键
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>effectiveCacheKey</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cacheKey</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>method</span><span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>url</span><span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>data</span> <span style=color:#f92672>||</span> {<span style=color:#e6db74>}</span><span style=color:#e6db74>)}`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 检查缓存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>cache</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>revalidate</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cachedResponse</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>apiCache</span>.<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>effectiveCacheKey</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>cachedResponse</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> Promise.<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>cachedResponse</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 设置请求超时
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>controller</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AbortController</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>timeoutId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>setTimeout</span>(() =&gt; <span style=color:#a6e22e>controller</span>.<span style=color:#a6e22e>abort</span>(), <span style=color:#a6e22e>timeout</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#a6e22e>url</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>method</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Content-Type&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;application/json&#34;</span>,
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>headers</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>data</span>) <span style=color:#f92672>:</span> <span style=color:#66d9ef>undefined</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>signal</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>controller</span>.<span style=color:#a6e22e>signal</span>,
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>clearTimeout</span>(<span style=color:#a6e22e>timeoutId</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 处理错误状态码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>ok</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>error</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>json</span>().<span style=color:#66d9ef>catch</span>(() =&gt; ({}));
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>`Request failed with status </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>status</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>      );
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>json</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果需要缓存，存储结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>cache</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>apiCache</span>.<span style=color:#a6e22e>set</span>(<span style=color:#a6e22e>effectiveCacheKey</span>, <span style=color:#a6e22e>result</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>;
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>clearTimeout</span>(<span style=color:#a6e22e>timeoutId</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 重新抛出错误，保留原始堆栈
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;AbortError&#34;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Request timeout after </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>timeout</span><span style=color:#e6db74>}</span><span style=color:#e6db74>ms`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>error</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 导出请求方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>api</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>get</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>url</span>, <span style=color:#a6e22e>options</span>) =&gt; <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>url</span>, { ...<span style=color:#a6e22e>options</span>, <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;GET&#34;</span> }),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>post</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>url</span>, <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>options</span>) =&gt;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>url</span>, { ...<span style=color:#a6e22e>options</span>, <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;POST&#34;</span>, <span style=color:#a6e22e>data</span> }),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>put</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>url</span>, <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>options</span>) =&gt;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>url</span>, { ...<span style=color:#a6e22e>options</span>, <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;PUT&#34;</span>, <span style=color:#a6e22e>data</span> }),
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>delete</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>url</span>, <span style=color:#a6e22e>options</span>) =&gt; <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>url</span>, { ...<span style=color:#a6e22e>options</span>, <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;DELETE&#34;</span> }),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 获取请求状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>invalidateCache</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>cacheKey</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>apiCache</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#a6e22e>cacheKey</span>);
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>clearCache</span><span style=color:#f92672>:</span> () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>apiCache</span>.<span style=color:#a6e22e>clear</span>();
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>然后为每个业务领域创建专用数据服务：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// api/products.js - 产品领域API
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>api</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./core&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>useMutation</span>, <span style=color:#a6e22e>useQuery</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../hooks/api&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 基础端点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>BASE_URL</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/api/products&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 产品API方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>productApi</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 获取产品列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>getProducts</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>filters</span> <span style=color:#f92672>=</span> {}) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>queryString</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>URLSearchParams</span>(<span style=color:#a6e22e>filters</span>).<span style=color:#a6e22e>toString</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>BASE_URL</span><span style=color:#e6db74>}${</span><span style=color:#a6e22e>queryString</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>`?</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>queryString</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>url</span>, { <span style=color:#a6e22e>cache</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 获取单个产品
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>getProduct</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>id</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>BASE_URL</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, { <span style=color:#a6e22e>cache</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 创建产品
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>createProduct</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>data</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>post</span>(<span style=color:#a6e22e>BASE_URL</span>, <span style=color:#a6e22e>data</span>);
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 更新产品
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>updateProduct</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>data</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>BASE_URL</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>data</span>);
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 删除产品
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>deleteProduct</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>id</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>api</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>BASE_URL</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 重新验证缓存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>invalidateProducts</span><span style=color:#f92672>:</span> () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>invalidateCache</span>((<span style=color:#a6e22e>key</span>) =&gt; <span style=color:#a6e22e>key</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;GET:&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>BASE_URL</span>));
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// React Hooks for products
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>useProducts</span>(<span style=color:#a6e22e>filters</span> <span style=color:#f92672>=</span> {}, <span style=color:#a6e22e>options</span> <span style=color:#f92672>=</span> {}) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>useQuery</span>(
</span></span><span style=display:flex><span>    [<span style=color:#e6db74>&#34;products&#34;</span>, <span style=color:#a6e22e>filters</span>],
</span></span><span style=display:flex><span>    () =&gt; <span style=color:#a6e22e>productApi</span>.<span style=color:#a6e22e>getProducts</span>(<span style=color:#a6e22e>filters</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>options</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>useProduct</span>(<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>options</span> <span style=color:#f92672>=</span> {}) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>useQuery</span>([<span style=color:#e6db74>&#34;product&#34;</span>, <span style=color:#a6e22e>id</span>], () =&gt; <span style=color:#a6e22e>productApi</span>.<span style=color:#a6e22e>getProduct</span>(<span style=color:#a6e22e>id</span>), <span style=color:#a6e22e>options</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>useCreateProduct</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>useMutation</span>((<span style=color:#a6e22e>data</span>) =&gt; <span style=color:#a6e22e>productApi</span>.<span style=color:#a6e22e>createProduct</span>(<span style=color:#a6e22e>data</span>), {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>onSuccess</span><span style=color:#f92672>:</span> () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 自动重新验证产品列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>productApi</span>.<span style=color:#a6e22e>invalidateProducts</span>();
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 更多数据操作钩子...
</span></span></span></code></pre></div><p>配套设计了自定义钩子来简化数据获取：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// hooks/api.js - 数据获取钩子
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>useState</span>, <span style=color:#a6e22e>useEffect</span>, <span style=color:#a6e22e>useCallback</span>, <span style=color:#a6e22e>useRef</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 简化版的查询钩子
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>useQuery</span>(<span style=color:#a6e22e>queryKey</span>, <span style=color:#a6e22e>queryFn</span>, <span style=color:#a6e22e>options</span> <span style=color:#f92672>=</span> {}) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>enabled</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>retry</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>retryDelay</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1000</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>onSuccess</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>onError</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>initialData</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>staleTime</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>, <span style=color:#75715e>// 数据有效期
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  } <span style=color:#f92672>=</span> <span style=color:#a6e22e>options</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 状态管理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>setData</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>(<span style=color:#a6e22e>initialData</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>error</span>, <span style=color:#a6e22e>setError</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>status</span>, <span style=color:#a6e22e>setStatus</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>(<span style=color:#e6db74>&#34;idle&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 引用值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>queryKeyRef</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useRef</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>queryKey</span>));
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fetchTimestampRef</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useRef</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>retryCountRef</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useRef</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 当前查询是否过期
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isStale</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useCallback</span>(() =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>staleTime</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> <span style=color:#a6e22e>fetchTimestampRef</span>.<span style=color:#a6e22e>current</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>staleTime</span>;
</span></span><span style=display:flex><span>  }, [<span style=color:#a6e22e>staleTime</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 执行查询
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>execute</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useCallback</span>(<span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 避免重复查询
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>status</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;loading&#34;</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果数据未过期且存在，不执行查询
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>data</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>isStale</span>()) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setStatus</span>(<span style=color:#e6db74>&#34;loading&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>retryCountRef</span>.<span style=color:#a6e22e>current</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fetchData</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>queryFn</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>setData</span>(<span style=color:#a6e22e>result</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>setError</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>setStatus</span>(<span style=color:#e6db74>&#34;success&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fetchTimestampRef</span>.<span style=color:#a6e22e>current</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>onSuccess</span>) <span style=color:#a6e22e>onSuccess</span>(<span style=color:#a6e22e>result</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 重试逻辑
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>retryCountRef</span>.<span style=color:#a6e22e>current</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>retry</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>retryCountRef</span>.<span style=color:#a6e22e>current</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>delay</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>retryDelay</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;function&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>?</span> <span style=color:#a6e22e>retryDelay</span>(<span style=color:#a6e22e>retryCountRef</span>.<span style=color:#a6e22e>current</span>)
</span></span><span style=display:flex><span>              <span style=color:#f92672>:</span> <span style=color:#a6e22e>retryDelay</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>setTimeout</span>(<span style=color:#a6e22e>fetchData</span>, <span style=color:#a6e22e>delay</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>setError</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>setStatus</span>(<span style=color:#e6db74>&#34;error&#34;</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>onError</span>) <span style=color:#a6e22e>onError</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fetchData</span>();
</span></span><span style=display:flex><span>  }, [<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>isStale</span>, <span style=color:#a6e22e>onError</span>, <span style=color:#a6e22e>onSuccess</span>, <span style=color:#a6e22e>queryFn</span>, <span style=color:#a6e22e>retry</span>, <span style=color:#a6e22e>retryDelay</span>, <span style=color:#a6e22e>status</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 初始请求和查询键变更时请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>useEffect</span>(() =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>currentQueryKey</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>queryKey</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>queryKeyRef</span>.<span style=color:#a6e22e>current</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>currentQueryKey</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>queryKeyRef</span>.<span style=color:#a6e22e>current</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>currentQueryKey</span>;
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 查询键变化，重置状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>setStatus</span>(<span style=color:#e6db74>&#34;idle&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>setData</span>(<span style=color:#a6e22e>initialData</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>setError</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>enabled</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>execute</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }, [<span style=color:#a6e22e>queryKeyRef</span>.<span style=color:#a6e22e>current</span>, <span style=color:#a6e22e>enabled</span>, <span style=color:#a6e22e>execute</span>, <span style=color:#a6e22e>initialData</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 刷新数据的方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>refetch</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useCallback</span>(() =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>execute</span>();
</span></span><span style=display:flex><span>  }, [<span style=color:#a6e22e>execute</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>error</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>isLoading</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>status</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;loading&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>isSuccess</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>status</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;success&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>isError</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>status</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;error&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>refetch</span>,
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 数据变更钩子
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>useMutation</span>(<span style=color:#a6e22e>mutationFn</span>, <span style=color:#a6e22e>options</span> <span style=color:#f92672>=</span> {}) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>onSuccess</span>, <span style=color:#a6e22e>onError</span>, <span style=color:#a6e22e>onSettled</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>options</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>setState</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>isLoading</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>isSuccess</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>isError</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>undefined</span>,
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>reset</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useCallback</span>(() =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setState</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>isLoading</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>isSuccess</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>isError</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>undefined</span>,
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }, []);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mutate</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useCallback</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>variables</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>setState</span>({ ...<span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>isLoading</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>mutationFn</span>(<span style=color:#a6e22e>variables</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>setState</span>({
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>isLoading</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>isSuccess</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>isError</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>data</span>,
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>onSuccess</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>onSuccess</span>(<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>variables</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>onSettled</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>onSettled</span>(<span style=color:#a6e22e>data</span>, <span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>variables</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>data</span>;
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>setState</span>({
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>isLoading</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>isSuccess</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>isError</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>error</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>undefined</span>,
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>onError</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>onError</span>(<span style=color:#a6e22e>error</span>, <span style=color:#a6e22e>variables</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>onSettled</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>onSettled</span>(<span style=color:#66d9ef>undefined</span>, <span style=color:#a6e22e>error</span>, <span style=color:#a6e22e>variables</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>error</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>mutationFn</span>, <span style=color:#a6e22e>onError</span>, <span style=color:#a6e22e>onSettled</span>, <span style=color:#a6e22e>onSuccess</span>, <span style=color:#a6e22e>state</span>]
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>    ...<span style=color:#a6e22e>state</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mutate</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reset</span>,
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这种架构大大改进了数据获取效率：</p><ol><li>自动缓存减少重复请求</li><li>统一错误处理和重试逻辑</li><li>响应式数据更新</li><li>自动数据失效</li></ol><p>重构后，API 请求数量减少了约 70%，数据加载时间减少了约 55%。</p><h2 id=代码分割与懒加载战略>代码分割与懒加载战略<a hidden class=anchor aria-hidden=true href=#代码分割与懒加载战略>#</a></h2><p>传统前端应用通常只考虑路由级别的代码分割，但我们更进一步：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 组件级别代码分割
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>React</span>, { <span style=color:#a6e22e>lazy</span>, <span style=color:#a6e22e>Suspense</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Loading</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../components/Loading&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 基于业务规则的高级懒加载
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>lazyWithPreload</span>(<span style=color:#a6e22e>factory</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Component</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>lazy</span>(<span style=color:#a6e22e>factory</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Component</span>.<span style=color:#a6e22e>preload</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>factory</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Component</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 复杂仪表板组件按需加载
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>DashboardMetrics</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>lazyWithPreload</span>(() =&gt; <span style=color:#66d9ef>import</span>(<span style=color:#e6db74>&#34;./DashboardMetrics&#34;</span>));
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>RevenueChart</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>lazyWithPreload</span>(() =&gt; <span style=color:#66d9ef>import</span>(<span style=color:#e6db74>&#34;./RevenueChart&#34;</span>));
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>OrdersTable</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>lazyWithPreload</span>(() =&gt; <span style=color:#66d9ef>import</span>(<span style=color:#e6db74>&#34;./OrdersTable&#34;</span>));
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>CustomerMap</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>lazyWithPreload</span>(() =&gt; <span style=color:#66d9ef>import</span>(<span style=color:#e6db74>&#34;./CustomerMap&#34;</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 基于用户角色决定是否预加载
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Dashboard</span>({ <span style=color:#a6e22e>userRole</span> }) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>activeTab</span>, <span style=color:#a6e22e>setActiveTab</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>(<span style=color:#e6db74>&#34;overview&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 预加载策略
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>useEffect</span>(() =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 管理员用户预加载所有组件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>userRole</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;admin&#34;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>DashboardMetrics</span>.<span style=color:#a6e22e>preload</span>();
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>RevenueChart</span>.<span style=color:#a6e22e>preload</span>();
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>OrdersTable</span>.<span style=color:#a6e22e>preload</span>();
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>CustomerMap</span>.<span style=color:#a6e22e>preload</span>();
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 普通用户只预加载基础组件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>DashboardMetrics</span>.<span style=color:#a6e22e>preload</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }, [<span style=color:#a6e22e>userRole</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 当用户将鼠标悬停在选项卡上时预加载对应组件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>handleTabHover</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>tab</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>tab</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;revenue&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>activeTab</span> <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#34;revenue&#34;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>RevenueChart</span>.<span style=color:#a6e22e>preload</span>();
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>tab</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;orders&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>activeTab</span> <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#34;orders&#34;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>OrdersTable</span>.<span style=color:#a6e22e>preload</span>();
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>tab</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;customers&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>activeTab</span> <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#34;customers&#34;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>CustomerMap</span>.<span style=color:#a6e22e>preload</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>div</span> <span style=color:#a6e22e>className</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;dashboard&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>nav</span> <span style=color:#a6e22e>className</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;dashboard-tabs&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>button</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>className</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>activeTab</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;overview&#34;</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;active&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>}
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>onClick</span><span style=color:#f92672>=</span>{() =&gt; <span style=color:#a6e22e>setActiveTab</span>(<span style=color:#e6db74>&#34;overview&#34;</span>)}
</span></span><span style=display:flex><span>        <span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Overview</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/button&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>button</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>className</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>activeTab</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;revenue&#34;</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;active&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>}
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>onClick</span><span style=color:#f92672>=</span>{() =&gt; <span style=color:#a6e22e>setActiveTab</span>(<span style=color:#e6db74>&#34;revenue&#34;</span>)}
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>onMouseEnter</span><span style=color:#f92672>=</span>{() =&gt; <span style=color:#a6e22e>handleTabHover</span>(<span style=color:#e6db74>&#34;revenue&#34;</span>)}
</span></span><span style=display:flex><span>        <span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Revenue</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/button&gt;</span>
</span></span><span style=display:flex><span>        {<span style=color:#75715e>/* 其他选项卡 */</span>}
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/nav&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>div</span> <span style=color:#a6e22e>className</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;dashboard-content&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        {<span style=color:#a6e22e>activeTab</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;overview&#34;</span> <span style=color:#f92672>&amp;&amp;</span> (
</span></span><span style=display:flex><span>          <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Suspense</span> <span style=color:#a6e22e>fallback</span><span style=color:#f92672>=</span>{<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Loading</span> <span style=color:#f92672>/&gt;</span>}<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>DashboardMetrics</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/Suspense&gt;</span>
</span></span><span style=display:flex><span>        )}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        {<span style=color:#a6e22e>activeTab</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;revenue&#34;</span> <span style=color:#f92672>&amp;&amp;</span> (
</span></span><span style=display:flex><span>          <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Suspense</span> <span style=color:#a6e22e>fallback</span><span style=color:#f92672>=</span>{<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Loading</span> <span style=color:#f92672>/&gt;</span>}<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>RevenueChart</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/Suspense&gt;</span>
</span></span><span style=display:flex><span>        )}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        {<span style=color:#75715e>/* 其他内容 */</span>}
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/div&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/div&gt;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>我们甚至对组件库做了更精细的拆分：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 按需加载的组件库
</span></span></span><span style=display:flex><span><span style=color:#75715e>// components/index.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> { <span style=color:#a6e22e>Button</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./Button&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> { <span style=color:#a6e22e>Card</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./Card&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> { <span style=color:#a6e22e>Table</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./Table&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>// ...避免一次导入所有组件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 使用示例 - 只导入需要的组件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Button</span>, <span style=color:#a6e22e>Card</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../components&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>// 而不是 import * from &#39;../components&#39;;
</span></span></span></code></pre></div><p>这种拆分策略将初始加载的组件库代码减少了约 85%，实现了真正的按需加载。</p><h2 id=渐进式架构迁移策略>渐进式架构迁移策略<a hidden class=anchor aria-hidden=true href=#渐进式架构迁移策略>#</a></h2><p>对于大型遗留应用，我们开发了一种"容器模式"，实现渐进式微前端迁移：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 遗留应用包装器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>React</span>, { <span style=color:#a6e22e>useEffect</span>, <span style=color:#a6e22e>useRef</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 包装旧应用的容器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>LegacyAppContainer</span>({ <span style=color:#a6e22e>route</span>, <span style=color:#a6e22e>onNavigate</span> }) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>containerRef</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useRef</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>useEffect</span>(() =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>containerRef</span>.<span style=color:#a6e22e>current</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 注入旧应用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>clean</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>mountLegacyApp</span>(<span style=color:#a6e22e>containerRef</span>.<span style=color:#a6e22e>current</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>initialRoute</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>route</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>onNavigate</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>newRoute</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 当旧应用导航时通知新架构
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>onNavigate</span>) <span style=color:#a6e22e>onNavigate</span>(<span style=color:#a6e22e>newRoute</span>);
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 清理旧应用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>clean</span>) <span style=color:#a6e22e>clean</span>();
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }, [<span style=color:#a6e22e>route</span>, <span style=color:#a6e22e>onNavigate</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>div</span> <span style=color:#a6e22e>className</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;legacy-container&#34;</span> <span style=color:#a6e22e>ref</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>containerRef</span>} <span style=color:#f92672>/&gt;</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 在旧应用中注入通信桥接器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>mountLegacyApp</span>(<span style=color:#a6e22e>container</span>, <span style=color:#a6e22e>options</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>initialRoute</span>, <span style=color:#a6e22e>onNavigate</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>options</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 加载旧应用脚本
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>script</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>createElement</span>(<span style=color:#e6db74>&#34;script&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>script</span>.<span style=color:#a6e22e>src</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/legacy-app.js&#34;</span>;
</span></span><span style=display:flex><span>  document.<span style=color:#a6e22e>head</span>.<span style=color:#a6e22e>appendChild</span>(<span style=color:#a6e22e>script</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 等待旧应用加载完成
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    window.<span style=color:#a6e22e>onLegacyAppLoaded</span> <span style=color:#f92672>=</span> () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 初始化旧应用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      window.<span style=color:#a6e22e>legacyApp</span>.<span style=color:#a6e22e>init</span>(<span style=color:#a6e22e>container</span>, <span style=color:#a6e22e>initialRoute</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 监听旧应用导航
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      window.<span style=color:#a6e22e>legacyApp</span>.<span style=color:#a6e22e>onNavigate</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>onNavigate</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 返回清理函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>resolve</span>(() =&gt; {
</span></span><span style=display:flex><span>        window.<span style=color:#a6e22e>legacyApp</span>.<span style=color:#a6e22e>unmount</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>innerHTML</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这种方式让我们能够增量迁移，而不是一次性重写整个应用。</p><h2 id=构建优化与部署策略>构建优化与部署策略<a hidden class=anchor aria-hidden=true href=#构建优化与部署策略>#</a></h2><p>除了前端架构，我们还优化了构建系统：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// webpack.prod.js - 优化生产构建
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>BundleAnalyzerPlugin</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;webpack-bundle-analyzer&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>CompressionPlugin</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;compression-webpack-plugin&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TerserPlugin</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;terser-webpack-plugin&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 基础配置...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>optimization</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>minimizer</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TerserPlugin</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>terserOptions</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>compress</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>drop_console</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>extractComments</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>      }),
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>splitChunks</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>chunks</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;all&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>maxInitialRequests</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>25</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>minSize</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>20000</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>cacheGroups</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vendors</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>test</span><span style=color:#f92672>:</span> <span style=color:#e6db74>/[\\/]node_modules[\\/]/</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>name</span>(<span style=color:#a6e22e>module</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 为每个npm包创建单独的chunk
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>packageName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>match</span>(
</span></span><span style=display:flex><span>              <span style=color:#e6db74>/[\\/]node_modules[\\/](.*?)([\\/]|$)/</span>
</span></span><span style=display:flex><span>            )[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>`npm.</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>packageName</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;@&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>common</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>minChunks</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>priority</span><span style=color:#f92672>:</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reuseExistingChunk</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>plugins</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 其他插件...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CompressionPlugin</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>algorithm</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;gzip&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>test</span><span style=color:#f92672>:</span> <span style=color:#e6db74>/\.(js|css|html|svg)$/</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>threshold</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>10240</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>minRatio</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0.8</span>,
</span></span><span style=display:flex><span>    }),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>ANALYZE</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BundleAnalyzerPlugin</span>(),
</span></span><span style=display:flex><span>  ].<span style=color:#a6e22e>filter</span>(Boolean),
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>我们还采用了增量部署策略，只更新变更的模块，大大减少了部署时间和风险。</p><h2 id=实际性能改进数据>实际性能改进数据<a hidden class=anchor aria-hidden=true href=#实际性能改进数据>#</a></h2><p>架构重构取得了显著成效:</p><table><thead><tr><th>指标</th><th>重构前</th><th>重构后</th><th>改进率</th></tr></thead><tbody><tr><td>首屏加载时间</td><td>8.6s</td><td>1.2s</td><td>86%</td></tr><tr><td>初始 JS 体积</td><td>1.6MB</td><td>280KB</td><td>83%</td></tr><tr><td>内存使用</td><td>平均 215MB</td><td>平均 76MB</td><td>65%</td></tr><tr><td>交互响应时间</td><td>平均 600ms</td><td>&lt;100ms</td><td>83%</td></tr><tr><td>API 请求数</td><td>~120 次/页面</td><td>~35 次/页面</td><td>71%</td></tr><tr><td>开发迭代周期</td><td>2 周</td><td>4 天</td><td>71%</td></tr></tbody></table><p>更重要的是，系统可维护性大幅提升，新功能开发速度提高了 3 倍。</p><h2 id=架构优化的关键教训>架构优化的关键教训<a hidden class=anchor aria-hidden=true href=#架构优化的关键教训>#</a></h2><p>总结这次重构的关键经验：</p><ol><li><p><strong>业务边界优先于技术边界</strong>: 按照业务域而非技术层分割应用，使团队能专注于完整功能而非技术层</p></li><li><p><strong>状态是首要性能瓶颈</strong>: 大型应用中，状态管理比渲染优化更能影响性能</p></li><li><p><strong>仅按需加载，甚至连框架也是</strong>: 对 React 等基础库应用代码分割，只加载必要部分</p></li><li><p><strong>数据获取策略是隐藏的金矿</strong>: 优化 API 调用模式常常比优化组件渲染更有效</p></li><li><p><strong>渐进增强胜过全面重构</strong>: 使用容器模式渐进迁移，而非一次性大规模重写</p></li><li><p><strong>监控和衡量是关键</strong>: 没有数据支持的架构决策往往是错误的</p></li></ol><h2 id=架构性能的未来趋势>架构性能的未来趋势<a hidden class=anchor aria-hidden=true href=#架构性能的未来趋势>#</a></h2><p>通过这个项目，我观察到几个值得关注的前端架构趋势：</p><ol><li><p><strong>服务器组件</strong>：React Server Components 等技术进一步模糊前后端边界</p></li><li><p><strong>细粒度包管理</strong>：ES 模块和 Import Maps 让浏览器直接管理依赖成为可能</p></li><li><p><strong>静态生成与增量静态再生</strong>：越来越多内容前置到构建时，而非运行时</p></li><li><p><strong>边缘计算</strong>：将渲染逻辑推向 CDN 边缘，减少延迟</p></li></ol><p>我们已经开始在项目中实验性地应用这些技术，未来的架构将更倾向于"分布式渲染"，而非传统的客户端/服务器二分法。</p><h2 id=结语>结语<a hidden class=anchor aria-hidden=true href=#结语>#</a></h2><p>前端架构设计与性能优化不是独立的关注点，而是密不可分的整体。正确的架构决策本身就能带来巨大的性能提升，无需事后优化。</p><p>通过拆分巨石应用为微前端、重构状态管理、优化数据获取策略和实施智能代码分割，我们不仅显著提升了应用性能，还改善了开发体验和系统可维护性。</p><p>架构层面的优化提供了比组件级优化更持久、更深远的价值。正如我们在这个项目中所证明的，思考系统的分形结构，从整体到局部，能带来超出预期的性能改进。</p><p>无论你是构建全新应用还是改进现有系统，记住这一点：伟大的性能始于伟大的架构，二者相辅相成，共同构建卓越的用户体验。</p><h2 id=相关阅读>相关阅读<a hidden class=anchor aria-hidden=true href=#相关阅读>#</a></h2><ul><li><a href=/zh/posts/vite-compile-optimization/>Vite 构建 React 项目的极致优化</a> - 了解如何优化前端构建流程</li><li><a href=/zh/posts/react-virtual-dom/>React 虚拟 DOM 深度剖析</a> - 深入理解 React 渲染机制</li><li><a href=/zh/posts/front-end-engineering/>现代前端工程化实践指南</a> - 探索更多工程化最佳实践</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.yss520.online/zh/tags/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/>架构设计</a></li><li><a href=https://www.yss520.online/zh/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/>性能优化</a></li><li><a href=https://www.yss520.online/zh/tags/react/>React</a></li><li><a href=https://www.yss520.online/zh/tags/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96/>前端工程化</a></li></ul><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 现代前端架构设计与性能优化 on x" href="https://x.com/intent/tweet/?text=%e7%8e%b0%e4%bb%a3%e5%89%8d%e7%ab%af%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e4%b8%8e%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96&amp;url=https%3a%2f%2fwww.yss520.online%2fzh%2fposts%2farchitecture-and-performance%2f&amp;hashtags=%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%2c%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%2cReact%2c%e5%89%8d%e7%ab%af%e5%b7%a5%e7%a8%8b%e5%8c%96"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 现代前端架构设计与性能优化 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwww.yss520.online%2fzh%2fposts%2farchitecture-and-performance%2f&amp;title=%e7%8e%b0%e4%bb%a3%e5%89%8d%e7%ab%af%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e4%b8%8e%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96&amp;summary=%e7%8e%b0%e4%bb%a3%e5%89%8d%e7%ab%af%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e4%b8%8e%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96&amp;source=https%3a%2f%2fwww.yss520.online%2fzh%2fposts%2farchitecture-and-performance%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 现代前端架构设计与性能优化 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.yss520.online%2fzh%2fposts%2farchitecture-and-performance%2f&title=%e7%8e%b0%e4%bb%a3%e5%89%8d%e7%ab%af%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e4%b8%8e%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 现代前端架构设计与性能优化 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.yss520.online%2fzh%2fposts%2farchitecture-and-performance%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 现代前端架构设计与性能优化 on whatsapp" href="https://api.whatsapp.com/send?text=%e7%8e%b0%e4%bb%a3%e5%89%8d%e7%ab%af%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e4%b8%8e%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%20-%20https%3a%2f%2fwww.yss520.online%2fzh%2fposts%2farchitecture-and-performance%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 现代前端架构设计与性能优化 on telegram" href="https://telegram.me/share/url?text=%e7%8e%b0%e4%bb%a3%e5%89%8d%e7%ab%af%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e4%b8%8e%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96&amp;url=https%3a%2f%2fwww.yss520.online%2fzh%2fposts%2farchitecture-and-performance%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 现代前端架构设计与性能优化 on ycombinator" href="https://news.ycombinator.com/submitlink?t=%e7%8e%b0%e4%bb%a3%e5%89%8d%e7%ab%af%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e4%b8%8e%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96&u=https%3a%2f%2fwww.yss520.online%2fzh%2fposts%2farchitecture-and-performance%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.yss520.online/zh/>Bruce的博客</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script src=/js/lightbox.js></script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>